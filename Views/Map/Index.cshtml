@model IEnumerable<LibrarySystem.Models.LibraryBranch>

@{
    ViewData["Title"] = "Şubeler Haritası";

    // Veri Hazırlama: Hatalı kayıtları yine temizliyoruz
    var mapData = new List<dynamic>();
    if (Model != null)
    {
        mapData = Model
            .Where(b => b.Location != null && Math.Abs(b.Location.Y) > 1.0) 
            .Select(b => new
            {
                name = b.Name,
                address = b.Address,
                lat = b.Location.Y, 
                lng = b.Location.X  
            }).ToList<dynamic>();
    }
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-geo-alt-fill"></i> Kütüphane Şubeleri</h4>
            
            <div>
                <a asp-controller="LibraryBranches" asp-action="Index" class="btn btn-outline-light me-2">
                    <i class="bi bi-list-ul"></i> Listeye Dön
                </a>

                <a asp-controller="LibraryBranches" asp-action="Create" class="btn btn-light text-primary fw-bold">
                    ➕ Yeni Şube Ekle
                </a>
            </div>
        </div>

        <div class="card-body p-0">
            <div id="map" style="height: 600px; width: 100%; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Haritayı Ankara'ya Kilitliyoruz (Zoom: 11)
    var map = L.map('map').setView([39.9334, 32.8597], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // 2. Verileri Al
    var branches = @Html.Raw(Json.Serialize(mapData)) || [];

    // 3. Raptiyeleri Ekle
    branches.forEach(function (branch) {
        if (branch.lat && branch.lng) {
            L.marker([branch.lat, branch.lng], { icon: blueIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align:center;">
                        <strong style="font-size:14px;">${branch.name}</strong><br>
                        <span style="font-size:12px; color:grey;">${branch.address}</span>
                    </div>
                `);
        }
    });
</script>